#!/bin/bash
# usage:
# bash Abbas_raw_heudiconv_slurm_run1_format.sh ${WD_NAME} ${STUDY_NAME} >> ${LOG_FILE}_run1.log
DATA_NAME=(${@:1:1})
echo ${DATA_NAME}

WD_DIR=${HOME}/scratch
DATA_DIR=${WD_DIR}/${DATA_NAME}
BIDS_DIR=${DATA_DIR}_BIDS
INFO_SUM_DIR=${DATA_DIR}_INFO_SUM
INFO_SUM_DIR_NAME=${DATA_NAME}_INFO_SUM
SLURM_LOG_OUT_DIR=${DATA_DIR}_Heudiconv_SLURM_LOG_OUT_run1
LOG_DIR_NAME=${DATA_NAME}_Heudiconv_SLURM_LOG_OUT_run1

# copying and merging information tsv files.
RUN_ID=$(tail -c 9 ${DATA_NAME}_heudiconv_run1.log)
mv heudi_vinc_r1-${RUN_ID}*.out ${LOG_DIR_NAME}
mv heudi_vinc_r1-${RUN_ID}*.err ${LOG_DIR_NAME}

for subject_id in $(find ${BIDS_DIR}/.heudiconv/ -maxdepth 1 -mindepth 1 | xargs -I {} basename {}); do
  cp ${BIDS_DIR}/.heudiconv/${subject_id}/info/*.tsv ${INFO_SUM_DIR}/
  cat ${INFO_SUM_DIR}/dicominfo_ses-1.tsv >> ${INFO_SUM_DIR}/ses-1.log
  cat ${INFO_SUM_DIR}/dicominfo_ses-2.tsv >> ${INFO_SUM_DIR}/ses-2.log
  cat ${INFO_SUM_DIR}/dicominfo_ses-3.tsv >> ${INFO_SUM_DIR}/ses-3.log
  cat ${INFO_SUM_DIR}/dicominfo_ses-4.tsv >> ${INFO_SUM_DIR}/ses-4.log
  cat ${INFO_SUM_DIR}/dicominfo_ses-5.tsv >> ${INFO_SUM_DIR}/ses-5.log
done

tar -czvf res/${INFO_SUM_DIR_NAME}.tar.gz ${INFO_SUM_DIR_NAME}
tar -czvf res/${LOG_DIR_NAME}.tar.gz ${LOG_DIR_NAME}
echo "Step4: Heudiconv Run1 Info zipped"
